---
title: "Predicting across sub-models"
author: "Alex Hayes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predicting across sub-models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In some cases there are computationally efficient tricks to get predictions for multiple fits from the same model[^1].

[^1]: Some terminology: a *model* is a family of probability distributions or functions. That is, a model is a set. An estimator is a way to calculate the parameters of a model from a dataset. The value of an estimator may depend on hyperparameters, which influence estimation but not the model. For example, $\lambda$ is a hyperparameter for the LASSO estimator for the linear model. The resulting estimates are a fit (sometimes referred to in the tidymodels universe as a sub-model).

Current thoughts on interface:

```{r}
library(glmnet)

x <- matrix(rnorm(100 * 5), 100, 5)
y <-  x[, 1] * 3 + rnorm(100)
fit <- cv.glmnet(x, y)
```

```{r}
test <- matrix(rnorm(10 * 5), 10, 5)
diag(test) <- NA
```

## Prediction at a single value of lambda

```{r}
library(tibble)
library(safepredict)

safe_predict(fit, test, params = "1-se")
safe_predict(fit, test, params = "min")
safe_predict(fit, test, params = 0.1)
```

## Predictions for many lambda at once

Now we need to keep track of the observation that a prediction belongs to, and also $\lambda$, so we add two new columns: `id` and `lambda`.

Note that missing of predictions can vary with `lambda`, as fewer columns are required to predict from sparse models.

```{r}
grid <- tibble(lambda = 1:10)

safe_predict(fit, test, type = "param_pred", params = grid)
```

## Predicting across binomial sub-models with `glmnet`

```{r}
y2 <- as.factor(rep(LETTERS[1:2], each = 50))

x2 <-  rbind(
  matrix(rnorm(50 * 3), 50, 3),
  matrix(rnorm(50 * 3, 10), 50, 3)
)

test2 <- head(x2, 10)
diag(test2) <- NA

fit2 <- cv.glmnet(x2,  y2, family = "binomial")
```

NOTE: here we have already specified `type`, so we can't pick between `"prob"` and `"class"` and just get class probabilities. I'm not a huge fan of this.

```{r}
safe_predict(fit2, test2, type = "param_pred", params = grid)
```

## Predicting across multinomial sub-models

```{r}
y3 <-  sample(LETTERS[1:5], 100, replace = TRUE)
fit3 <- cv.glmnet(x, y3, family = "multinomial")

safe_predict(fit3, test, type = "param_pred", params = grid)
```

The behavior for multivariate gaussian families is essentially the same.

NOTE: currently the user has always has to specify `type`. I'm trying to decide if I like this or if it's somewhat verbose.

**Next steps**: A demonstration of sub-model prediction for a model with more than one hyperparameter
